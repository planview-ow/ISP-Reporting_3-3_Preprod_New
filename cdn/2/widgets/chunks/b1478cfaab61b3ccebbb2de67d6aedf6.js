"use strict";(self.webpackChunkexb_client=self.webpackChunkexb_client||[]).push([[4856],{14856:(e,r,t)=>{t.r(r),t.d(r,{RunWorkflow:()=>f});var o=t(68230),s=t(3091),i=t(47130),n=t(27387);const a=/(\/\/[^\/]+)\/geocortex\/workflow\/service\/?$/i,c="$1/vertigisstudio/workflow/service";var l=t(34545),u=t(69621),w=t(94981);let f=class{async execute(e,r,t){var o=n.U.string("url",e.url,n.U.never),s=(0,w.M6)(o);if(s){var i=this.getAuthenticationToken(s.portalUrl),a=(0,w.i6)(s,i);const o=r.cancellationToken;a=await(0,w.uT)(a,t,o);const n=t.create();if(o.finally((function(){n.cancel()})),this.isServerWorkflow(a))return this.runServerWorkflow(a,e.arguments,n,o,s.portalUrl,i)}return this.runClientWorkflow(o,e.arguments,r)}getAuthenticationToken(e){return(0,w.Ni)(e)}isServerWorkflow(e){if(null==e)return!1;var r=e.properties;return null!=r&&(e=r.isServerWorkflow,r=r.serverUrl,!(!0!==e||!r))}async runServerWorkflow(e,r,t,o,s,i){let n,l,w=e.properties.serverUrl;if(w=w.replace(/\/+$/,""),i&&"public"!==e.access)try{n=await(0,u.Yi)(w,s,i,t)}catch(e){if(!a.test(w))throw e;w=w.replace(a,c),n=await(0,u.Yi)(w,s,i,t)}r={workflow:{id:e.id},inputs:r};try{l=await(0,u.uu)(w,n,r,t)}catch(e){if(!a.test(w))throw e;w=w.replace(a,c),l=await(0,u.uu)(w,n,r,t)}return r=l.ticket,{result:await this.checkResult(w,n,r,1e3,t,o)}}async delay(e){return new Promise((r=>setTimeout(r,e)))}async checkResult(e,r,t,o,s,i){return await this.checkJobStatus(e,r,t,s,i)||(await this.delay(o),this.checkResult(e,r,t,1.1*o,s,i))}async checkJobStatus(e,r,t,o,s){if(o=o.new(),s.finally((function(){o.cancel()})),o.request.url=`${e}/job/artifacts?ticket=${t}`,r&&(o.request.headers.Authorization=`Bearer ${r}`),!await o.send())throw console.error("Unable to check workflow status.",o.response.message),new Error("Unable to check workflow status.");const i=JSON.parse(o.response.content);if(console.debug(i),i.results&&i.results.some((e=>"JobQuit"===e.$type))){if(r=i.results.filter((e=>"JobResult"===e.$type))[0],r)return r.outputs;throw console.error("Server workflow failed.",`${e}/job/logs?ticket=${t}&`),new Error("Server workflow failed.")}return null}async runClientWorkflow(e,r,t){const o=t.ambient.trivia;var i=(i=t.ambient.activityContexts)?i.$$form:void 0;try{var n=i?{$$form:i}:{};return{result:await o.runWorkflow(e,r,n,o.isDescendantOf)}}catch(e){if(!(e instanceof s.bs))throw e;t.ambient.reject(e)}}};f.action="gcx:wf:core::RunWorkflow",f.suite="gcx:wf:builtin",f=(0,o.gn)([(0,i.QZ)(l.m)],f)}}]);